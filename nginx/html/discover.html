<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Discover ‚Äî Pineapple Subreddit Index</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="/fruit-pineapple.svg" type="image/svg+xml">
  <link rel="shortcut icon" href="/fruit-pineapple.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-X5E2L44KYG"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-X5E2L44KYG');
  </script>
</head>
<body>
  <nav class="main-nav">
    <a href="/" class="nav-link"><span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.4 7.7C16.4 6.4 19 7 19 7C17.2 4.6 15.1 4.7 13.6 5.2V5C14.7 3.4 16.9 3.5 16.9 3.5C15.3 2.1 13.9 2.5 13 3C12.5 1.8 12 1 12 1C11.6 1.7 11.3 2.4 11 3.1C10.1 2.5 8.6 2.1 7 3.5C7 3.5 9.3 3.5 10.4 5.2C8.9 4.7 6.8 4.6 5 7C5 7 7.6 6.4 9.6 7.7C7.5 8.9 6 11.7 6 15C6 19.4 8.7 23 12 23S18 19.4 18 15C18 11.7 16.5 8.9 14.4 7.7M15.8 16.8C15.7 17.2 15.6 17.6 15.4 18L14 16L12.5 18L14.1 20.1C13.8 20.3 13.6 20.5 13.3 20.7L12 19L10.7 20.7C10.4 20.6 10.1 20.4 9.9 20.1L11.5 18L10 16L8.5 17.9C8.4 17.5 8.2 17.1 8.1 16.7L9.5 15L8.2 13.2C8.3 12.8 8.4 12.4 8.6 12L10 14L11.5 12L9.9 9.9C10.2 9.7 10.4 9.5 10.7 9.3L12 11L13.3 9.3C13.6 9.4 13.9 9.6 14.1 9.9L12.5 12L14 14L15.5 12.1C15.6 12.5 15.8 12.9 15.9 13.3L14.5 15L15.8 16.8M12 13L13.5 15L12 17L10.5 15L12 13Z" /></svg></span><span class="nav-text">Browse</span></a>
    <a href="/list" class="nav-link"><span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg></span><span class="nav-text">Advanced</span></a>
    <a href="/discover" class="nav-link active"><span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,1L17.74,3.75L15,5L17.74,6.26L19,9L20.25,6.26L23,5L20.25,3.75M9,4L6.5,9.5L1,12L6.5,14.5L9,20L11.5,14.5L17,12L11.5,9.5M19,15L17.74,17.74L15,19L17.74,20.25L19,23L20.25,20.25L23,19L20.25,17.74" /></svg></span><span class="nav-text">Discover</span></a>
    <a href="/analytics" class="nav-link"><span class="nav-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16,11.78L20.24,4.45L21.97,5.45L16.74,14.5L10.23,10.75L5.46,19H22V21H2V3H4V17.54L9.5,8L16,11.78Z" /></svg></span><span class="nav-text">Analytics</span></a>
  </nav>

  <div class="discover-container">
    <h1>Discover Subreddits</h1>
    <p class="lead">Find trending communities, hidden gems, and the fastest growing subreddits in our index.</p>

    <!-- Trending This Week -->
    <div class="section">
      <div class="section-header">
        <div>
          <h2 class="section-title">üî• Trending</h2>
          <p class="section-subtitle">Most mentioned recently</p>
        </div>
        <div class="time-selector">
          <button class="time-btn active" data-section="trending" data-days="7">7d</button>
          <button class="time-btn" data-section="trending" data-days="14">14d</button>
          <button class="time-btn" data-section="trending" data-days="30">30d</button>
        </div>
      </div>
      <div id="trending-list" class="subreddit-grid">
        <div class="loading">Loading trending subreddits...</div>
      </div>
    </div>

    <!-- Hidden Gems -->
    <div class="section">
      <div class="section-header">
        <div>
          <h2 class="section-title">üíé Hidden Gems</h2>
          <p class="section-subtitle">Active communities with smaller audiences</p>
        </div>
        <div class="time-selector">
          <button class="time-btn" data-section="gems" data-max="5000">< 5K</button>
          <button class="time-btn active" data-section="gems" data-max="10000">< 10K</button>
          <button class="time-btn" data-section="gems" data-max="25000">< 25K</button>
        </div>
      </div>
      <div id="gems-list" class="subreddit-grid">
        <div class="loading">Loading hidden gems...</div>
      </div>
    </div>

    <!-- Fastest Growing -->
    <div class="section">
      <div class="section-header">
        <div>
          <h2 class="section-title">üìà Fastest Growing</h2>
          <p class="section-subtitle">Biggest increase in mentions</p>
        </div>
        <div class="time-selector">
          <button class="time-btn" data-section="growing" data-days="14">14d</button>
          <button class="time-btn active" data-section="growing" data-days="30">30d</button>
          <button class="time-btn" data-section="growing" data-days="60">60d</button>
        </div>
      </div>
      <div id="growing-list" class="subreddit-grid">
        <div class="loading">Loading fastest growing...</div>
      </div>
    </div>
  </div>

  <script>
    let currentData = {
      trending: { days: 7, data: null },
      gems: { max_subscribers: 10000, data: null },
      growing: { days: 30, data: null }
    };

    // Format numbers with K/M suffix
    function formatNumber(num) {
      if (!num) return '0';
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }

    // Create subreddit card HTML
    function createSubredditCard(sub, type = 'default') {
      const badge = type === 'trending' ? `<span class="badge">Hot</span>` :
                    type === 'growing' ? `<span class="badge growth">+${sub.growth_ratio}x</span>` : '';
      
      const title = sub.title ? `<div class="subreddit-title">${escapeHtml(sub.title)}</div>` : '';
      
      let stats = [];
      if (sub.recent_mentions) {
        stats.push(`<span class="stat"><span class="stat-value">${formatNumber(sub.recent_mentions)}</span> recent</span>`);
      }
      if (sub.mentions) {
        stats.push(`<span class="stat"><span class="stat-value">${formatNumber(sub.mentions)}</span> mentions</span>`);
      }
      if (sub.total_mentions) {
        stats.push(`<span class="stat"><span class="stat-value">${formatNumber(sub.total_mentions)}</span> total</span>`);
      }
      if (sub.subscribers) {
        stats.push(`<span class="stat"><span class="stat-value">${formatNumber(sub.subscribers)}</span> subs</span>`);
      }
      
      return `
        <div class="subreddit-card">
          ${badge}
          <div class="subreddit-name">
            <a href="https://reddit.com/${sub.display_name_prefixed || 'r/' + sub.name}" target="_blank" rel="noopener noreferrer">
              ${escapeHtml(sub.display_name_prefixed || 'r/' + sub.name)}
            </a>
          </div>
          ${title}
          <div class="subreddit-stats">
            ${stats.join('')}
          </div>
        </div>
      `;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    // Load data functions
    async function loadTrending(days = 7) {
      const container = document.getElementById('trending-list');
      container.innerHTML = '<div class="loading">Loading...</div>';
      
      try {
        const response = await fetch(`/api/discover/trending?days=${days}`);
        const data = await response.json();
        currentData.trending = { days, data };
        
        if (data.items && data.items.length > 0) {
          container.innerHTML = data.items.slice(0, 12).map(sub => createSubredditCard(sub, 'trending')).join('');
        } else {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><p>No trending subreddits found</p></div>';
        }
      } catch (error) {
        console.error('Error loading trending:', error);
        container.innerHTML = '<div class="empty-state"><p>Error loading data</p></div>';
      }
    }

    async function loadHiddenGems(maxSubs = 10000) {
      const container = document.getElementById('gems-list');
      container.innerHTML = '<div class="loading">Loading...</div>';
      
      try {
        const response = await fetch(`/api/discover/hidden_gems?max_subscribers=${maxSubs}`);
        const data = await response.json();
        currentData.gems = { max_subscribers: maxSubs, data };
        
        if (data.items && data.items.length > 0) {
          container.innerHTML = data.items.slice(0, 12).map(sub => createSubredditCard(sub, 'gem')).join('');
        } else {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üíé</div><p>No hidden gems found</p></div>';
        }
      } catch (error) {
        console.error('Error loading gems:', error);
        container.innerHTML = '<div class="empty-state"><p>Error loading data</p></div>';
      }
    }

    async function loadFastestGrowing(days = 30) {
      const container = document.getElementById('growing-list');
      container.innerHTML = '<div class="loading">Loading...</div>';
      
      try {
        const response = await fetch(`/api/discover/fastest_growing?days=${days}`);
        const data = await response.json();
        currentData.growing = { days, data };
        
        if (data.items && data.items.length > 0) {
          container.innerHTML = data.items.slice(0, 12).map(sub => createSubredditCard(sub, 'growing')).join('');
        } else {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìà</div><p>No growing subreddits found</p></div>';
        }
      } catch (error) {
        console.error('Error loading growing:', error);
        container.innerHTML = '<div class="empty-state"><p>Error loading data</p></div>';
      }
    }

    // Button handlers
    document.querySelectorAll('.time-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const section = this.dataset.section;
        const days = this.dataset.days;
        const maxSubs = this.dataset.max;
        
        // Update active state
        this.parentElement.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // Load data
        if (section === 'trending' && days) {
          loadTrending(parseInt(days));
        } else if (section === 'gems' && maxSubs) {
          loadHiddenGems(parseInt(maxSubs));
        } else if (section === 'growing' && days) {
          loadFastestGrowing(parseInt(days));
        }
      });
    });

    // Cookie functions for age gate
    function setCookie(name, value, days) {
      const date = new Date();
      date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
      document.cookie = `${name}=${value};expires=${date.toUTCString()};path=/`;
    }

    function getCookie(name) {
      const nameEQ = name + '=';
      const cookies = document.cookie.split(';');
      for (let c of cookies) {
        c = c.trim();
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length);
      }
      return null;
    }

    // Age gate modal
    function showAgeGate(onConfirm) {
      const overlay = document.createElement('div');
      overlay.className = 'age-modal-overlay';
      const box = document.createElement('div');
      box.className = 'age-modal-box';
      const h = document.createElement('h2');
      h.textContent = 'Age confirmation';
      const p = document.createElement('p');
      p.textContent = 'This page may contain explicit (18+) content. Please confirm that you are of the required age to visit this website.';
      const actions = document.createElement('div');
      actions.className = 'age-modal-actions';
      const confirmBtn = document.createElement('button');
      confirmBtn.className = 'btn';
      confirmBtn.textContent = 'I am 18+';
      const leaveBtn = document.createElement('button');
      leaveBtn.className = 'btn btn-ghost';
      leaveBtn.textContent = 'Leave';
      actions.appendChild(leaveBtn);
      actions.appendChild(confirmBtn);
      box.appendChild(h);
      box.appendChild(p);
      box.appendChild(actions);
      overlay.appendChild(box);
      document.body.appendChild(overlay);
      document.body.style.overflow = 'hidden';

      confirmBtn.addEventListener('click', () => {
        try { setCookie('sindex_age_confirmed', '1', 365); } catch(e) {}
        overlay.remove();
        document.body.style.overflow = '';
        onConfirm();
      });

      leaveBtn.addEventListener('click', () => {
        try { overlay.remove(); } catch(e) {}
        window.location.href = 'about:blank';
      });

      confirmBtn.focus();
    }

    // Check age confirmation and load
    function initWithAgeGate() {
      try {
        const confirmed = getCookie('sindex_age_confirmed');
        if (confirmed === '1') {
          loadTrending(7);
          loadHiddenGems(10000);
          loadFastestGrowing(30);
          return;
        }
      } catch(e) { /* ignore and show gate */ }
      showAgeGate(() => {
        loadTrending(7);
        loadHiddenGems(10000);
        loadFastestGrowing(30);
      });
    }

    // Initial load with age gate
    initWithAgeGate();
  </script>
</body>
</html>
